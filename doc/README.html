<!DOCTYPE HTML>
<html>
<head>
  <meta charset='utf-8'>
  <title>Preview</title>
  <!--this style include the test_md/css screen.css(first) and base.css -->
  <style type="text/css">
    pre code{display:block;background:#fff;color:#4d4d4c;font-family:Menlo, Monaco, Consolas, monospace;font-size:12px;line-height:1.5;border:1px solid #ccc;padding:10px}html,body,div,span,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,code,del,dfn,em,img,q,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;font-weight:inherit;font-style:inherit;font-size:100%;font-family:inherit;vertical-align:baseline}table{border-collapse:separate;border-spacing:0}caption,th,td{text-align:left;font-weight:normal}table,td,th{vertical-align:middle}blockquote:before,blockquote:after,q:before,q:after{content:""}blockquote,q{quotes:"" ""}a img{border:none}body{margin:10px}html{height:100%}body{padding:0;margin:0;font:14px/22px "adelle", Georgia, sans-serif;font-size-adjust:none;font-style:normal;font-variant:normal;font-weight:normal;background:#f4f6ec}a{color:#369}#markdown-toc{float:left;width:230px;margin-right:30px;margin-top:40px}#markdown-toc a{display:block;font-weight:bold;text-decoration:none}#markdown-toc #sections{list-style-type:none;border-bottom:3px solid rgba(0,0,0,0.1);padding-bottom:10px;margin-bottom:10px}#markdown-toc #sections>li>a{padding:5px 0;color:#444;font-size:16px}#markdown-toc #sections ul{margin-bottom:15px}#markdown-toc #sections ul li{list-style-type:none}#markdown-toc #sections ul li a{padding:1px 15px;font-size:13px;font-weight:normal}#markdown-toc .extra{padding:5px 0;min-height:1.4em}#markdown-toc .extra a{color:#555;font-size:14px}#markdown-toc #travis img{margin-top:10px;display:block}#markdown-toc>*:last-child{margin-bottom:20px}#content{padding:30px 30px 20px 30px;min-height:100px;width:600px;background:#fff;float:left;border:1px solid rgba(0,0,0,0.2);-webkit-border-radius:3px 3px 0 0;-moz-border-radius:3px 3px 0 0;border-radius:3px 3px 0 0;margin-top:15px}#content #loader{color:#888;width:300px;height:24px;line-height:24px;position:absolute;top:30px;left:30px;background:url("data:image/gif;base64,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") no-repeat center left;padding-left:32px;font-size:18px}#content>p{zoom:1}#content>p:before,#content>p:after{content:"";display:table}#content>p:after{clear:both}#content p{padding:0 0 0.8125em 0;color:#444}#content p img{float:left;margin:0.5em 0.8125em 0.8125em 0;padding:0}#content img{max-width:100%}#content h1,#content h2,#content h3,#content h4,#content h5,#content h6{font-weight:bold;line-height:1.2em}#content h1{font-size:2.125em;margin-bottom:0.4em}#content h2{font-size:1.7em;margin:0.855em 0 0.4em;color:#cc333f}#content h3{font-size:1.3em;margin:0.956em 0 0.4em}#content h4{font-size:1.1em;margin:1.161em 0 0.4em}#content h5,#content h6{font-size:1em;font-weight:bold;margin:1.238em 0 0.4em}#content>h1,#content>h2{margin-top:0}#content ul{list-style-position:outside}#content li ul,#content li ol{margin:0 1.625em}#content ul,#content ol{margin:0 0 1.625em 1.25em}#content dl{margin:0 0 1.625em 0}#content dl dt{font-weight:bold}#content dl dd{margin-left:1.625em}#content a{text-decoration:none}#content a:hover{text-decoration:underline}#content table{margin-bottom:1.625em;border-collapse:collapse}#content th{font-weight:bold}#content tr,#content th,#content td{margin:0;padding:0 1.625em 0 1em;height:26px}#content tfoot{font-style:italic}#content caption{text-align:center;font-family:Georgia, serif}#content abbr,#content acronym{border-bottom:1px dotted #000}#content address{margin-top:1.625em;font-style:italic}#content del{color:#000}#content blockquote{padding:1em 1em 1.625em 1em;font-family:georgia, serif;font-style:italic}#content blockquote:before{content:"\201C";font-size:3em;margin-left:-0.625em;font-family:georgia, serif;color:#aaa;line-height:0}#content blockquote>p{padding:0;margin:0}#content strong{font-weight:bold}#content em,#content dfn{font-style:italic}#content dfn{font-weight:bold}#content pre,#content code{margin:0 0 1.625em;white-space:pre}#content pre,#content code,#content tt{font-size:1em;font-family:Consolas, "Andale Mono WT", "Andale Mono", "Lucida Console", "Lucida Sans Typewriter", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono", "Nimbus Mono L", Monaco, "Courier New", Courier, monospace;line-height:1.5}#content code{background:#f7f8f1;padding:1px 2px;border:1px solid #ccc}#content pre code{padding:10px 12px;word-wrap:normal;overflow-y:auto}#content tt{display:block;margin:1.625em 0}#content hr{margin-bottom:1.625em}#content table{font-family:"Helvetica Neue", Helvetica, Arial, sans-serif;width:100%}#content th,#content td{padding:5px 10px;border:1px solid #ccc}#content th{background:#eee;padding:7px 10px}#content td{font-size:0.9em;border-color:#ddd}#content tbody tr:nth-child(2n){background:#f5f5f5}@media only screen and (max-width: 480px){#container{width:100%}#markdown-toc{width:100%;margin-top:10px;float:none}#markdown-toc #sections,#markdown-toc #header,#markdown-toc .extra{padding-left:30px;padding-right:30px}#content{-webkit-border-radius:0;-moz-border-radius:0;border-radius:0;border-width:1px;float:none;margin:0;width:100%;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}}@media only screen and (min-device-pixel-ratio: 1.5), only screen and (min-resolution: 1.5dppx){#github-ribbon img{width:100px}}*{margin:0;padding:0}body{margin-left:40px}#markdown-toc{float:right !important;position:fixed;left:745px;height:90%;overflow:auto}#content{float:left !important;filter:progid:DXImageTransform.Microsoft.Shadow(color=#909090,direction=120,strength=4);-moz-box-shadow:2px 2px 10px #909090;-webkit-box-shadow:2px 2px 10px #909090;box-shadow:2px 2px 10px #909090}#markdown-toc{width:auto;max-width:300px !important;top:40px}#markdown-toc>li>ul>li>a{color:#cc333f;margin-top:10px}#markdown-toc>li>ul>li>ul>li>a,h3{color:#009999}#markdown-toc>li>ul>li>ul>li>ul>li>a,h4{color:#669999}#markdown-toc>li>a{margin-bottom:20px;padding-bottom:20px;border-bottom:3px solid rgba(0,0,0,0.1);font-size:20px;color:#000000}#content code{border-radius:3px}#content>h1{font-size:2.0em}.title{font-size: 2.4em;color: #ff5456 !important}#markdown-toc>li{margin-bottom: 30px}#markdown-toc>li>a{padding-bottom:10px;}#markdown-toc>li>a{font-size: 18px;}#markdown-toc{white-space: nowrap}h1,h2,h3,h4,h5,h6{margin-bottom:1em !important;}#markdown-toc>li>ul>li>ul>li>ul>li>ul>li>a,h5{color:#7bb8b8 !important}#markdown-toc>li>ul>li>ul>li>ul>li>a,h4{color:#6c9e00 !important}#markdown-toc>li>ul>li>ul>li>a, h3{color:#3C6E6E  !important}#markdown-toc>li>ul>li>a, h2{color:#4E6EA0 !important}#markdown-toc>li>a, h1{color:#134da5 !important}body{background:#ffffff}.code pre{border:1px solid rgb(204, 204, 204);overflow:auto;border-radius:3px}.code pre{background: none repeat scroll 0% 0% rgb(247, 248, 241)}#content sup{background: #c8deff}#content sup a{color: #273650}#content .footnotes{background: rgba(0,0,0,0.1);padding: 10px 0 0px 10px;border-radius: 5px}.reversefootnote{color: #000000;}
  </style>
  
</head>

<body>
  <div id="content">
    
<ul id="markdown-toc">
  <li><a href="#la-marco-sinatra-sinatra-based-web-framework" id="markdown-toc-la-marco-sinatra-sinatra-based-web-framework">La-Marco-Sinatra: Sinatra Based Web Framework</a>    <ul>
      <li><a href="#section" id="markdown-toc-section">概述</a></li>
      <li><a href="#section-1" id="markdown-toc-section-1">详细</a>        <ul>
          <li><a href="#pumapry-byebug" id="markdown-toc-pumapry-byebug">Puma管理和pry-byebug测试</a></li>
          <li><a href="#route" id="markdown-toc-route">Route机制</a></li>
          <li><a href="#cucumber" id="markdown-toc-cucumber">Cucumber测试</a></li>
          <li><a href="#pathslim" id="markdown-toc-pathslim">Path管理和Slim模板</a>            <ul>
              <li><a href="#path" id="markdown-toc-path">获取特定path</a></li>
              <li><a href="#slimhelper" id="markdown-toc-slimhelper">SlimHelper</a></li>
            </ul>
          </li>
          <li><a href="#i18n" id="markdown-toc-i18n">模板I18n</a></li>
          <li><a href="#section-2" id="markdown-toc-section-2">面包屑</a></li>
          <li><a href="#formtable-helper" id="markdown-toc-formtable-helper">Form和Table Helper</a></li>
          <li><a href="#assetsjscsslogo" id="markdown-toc-assetsjscsslogo">Assets（js/css/logo等静态图片）管理</a></li>
          <li><a href="#logging-system" id="markdown-toc-logging-system">Logging System</a>            <ul>
              <li><a href="#labacktracecleaner" id="markdown-toc-labacktracecleaner">LaBacktraceCleaner</a></li>
              <li><a href="#labufferedlogger" id="markdown-toc-labufferedlogger">LaBufferedLogger</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#restful-api" id="markdown-toc-restful-api">Restful API</a></li>
    </ul>
  </li>
</ul>

<h1 id="la-marco-sinatra-sinatra-based-web-framework">La-Marco-Sinatra: Sinatra Based Web Framework</h1>

<blockquote>
  <p>注意：<code>sinatra</code>如果出现“undefined method <code>join</code> for #<string> ...”错误，参照`doc/monkey_patch.html`文件。</string></p>
</blockquote>

<h2 id="section">概述</h2>

<ul>
  <li><code>config.ru</code>实现rack标准，通过<code>puma</code>启动服务，非生产环境加载<code>pry-byebug</code>测试</li>
  <li><code>Route</code>机制，独立app（如bluemoon）可无缝加载或移除</li>
  <li>Cucumber测试</li>
  <li>基于<code>Route</code>的path helper，实现对面包屑的程序化管理</li>
  <li>slim helper, form和table helper</li>
  <li>基于stackupper的asset helper和compiler</li>
  <li>I18n机制，包括JS/Ruby同步</li>
  <li>API helpers, API测试和文档helper</li>
</ul>

<p>Center Logger和Email需要数据库支持，放到单独的程序中实现。</p>

<h2 id="section-1">详细</h2>

<h3 id="pumapry-byebug">Puma管理和pry-byebug测试</h3>

<p>不再使用<code>foreman</code>，直接通过<code>rake s</code>（<code>rake server</code>）启动puma服务，PID文件保存在本地<code>tmp/puma.pid</code>，因此<code>repuma</code>命令不再起作用。需重启服务器时再次执行<code>rake s</code>即可。</p>

<p>更细腻的控制可以通过<code>rake puma:start</code>, <code>rake puma:stop</code>和<code>rake puma:restart</code>实现。</p>

<p><code>Guardfile</code>里添加了监听puma的功能。如果puma服务尚没有启动，则<code>bundle exec guard</code>也会在<code>guard</code>的控制台启动puma。如果puma已经启动，则<code>guard</code>会在<code>app/lib/config</code>文件夹下所有ruby文件发生变化时重启puma服务。</p>

<p>因为<code>guard</code>会重定向输入输出，在<code>guard</code>控制台下无法使用<code>pry</code>进行debug。需要使用<code>pry</code>时，应在单独的terminal窗口启动puma，再在另外的窗口启动<code>guard</code>。</p>

<p>单独窗口启动puma时，在程序代码中插入<code>binding.pry</code>，如：</p>

<p>```ruby
get(‘/some/route’) do
  user = User.find(…)
  binding.pry</p>

<p>…
end
```</p>

<p>则<code>rake s</code>启动的puma进程会在此处停止并启动pry控制台，在这里可以</p>

<pre><code>pry&gt; ap user
</code></pre>

<p>来确认变量，或插入并执行任意代码。</p>

<p>注意：<code>rake server</code>通过<code>tmp/puma.pid</code>文件的存在与否判断puma是否在运行。如果puma因某种原因未能在退出时删除此文件导致puma无法启动，可手动删除。</p>

<h3 id="route">Route机制</h3>

<p>参照<code>doc/route.html</code></p>

<p><code>config/boot.rb</code>会在<code>config/routes.rb</code>文件存在时调用它，后者会顺序加载所有<code>app/helpers</code>和<code>app/pages</code>下面的ruby文件。旧版的<code>app/lib/*</code>文件移动到<code>lib</code>目录下，需要使用时手动加载（一般来说应该已经被base controller加载了）。</p>

<p><code>app/base</code>目录取消，base controllers应该直接放在<code>app/pages</code>文件夹下，<code>config/routes.rb</code>会“从浅到深”的加载<code>app/pages</code>下的所有文件。</p>

<h3 id="cucumber">Cucumber测试</h3>

<p>Cucumber支持通过<code>poltergeist</code>或<code>chrome</code>两种driver测试，默认是<code>poltergeist</code>。两者均直接连接puma在本地监听的8080端口进行测试。因此cucumber必须在puma启动后方可执行。</p>

<p><code>chrome</code>和<code>poltergeist</code>需要分别单独安装<code>chrome-web-driver</code>和<code>phantomjs</code>之后才可以使用。</p>

<p>需使用<code>chrome</code>测试时，可指定<code>DRIVER=chrome rake features</code>，也可以使用短缩版的命令<code>rake cc</code>（Cucumber with Chrome）。</p>

<p><code>rake accept</code>则会将测试结果以html报告的形式保存到<code>doc/cucumber.html</code>。</p>

<p>在确保puma已经启动的情况下，可通过<code>rake puma:restart &amp;&amp; rake f</code>来先重启服务器再执行cucumber。注意如果puma没有另外启动，则<code>rake s</code>会占据整个进程，<code>rake f</code>无法获得启动机会。因此<strong>不要使用</strong><code>rake s &amp;&amp; rake f</code>。</p>

<p>Guard设置为检测本地文件变化并重启服务器，同时监听<code>features/*.feature</code>或<code>app/pages/*.rb</code>文件变化并执行cucumber。当然同样需要puma在另外的窗口运行时才有意义。</p>

<h3 id="pathslim">Path管理和Slim模板</h3>

<h4 id="path">获取特定path</h4>

<p><code>to</code>（<code>url</code>的同名函数）是sinatra提供的获取同一controller内其它页面URL的方法，比如</p>

<pre><code>class UserPage &lt; WebApplication
  get('/settings') { ... }
  get('/') { rediret to('settings') } # redirect to the url of above

  Route &lt;&lt; self # =&gt; mount to '/users/'
end
</code></pre>

<p><code>Route.to</code>方法（可接受多个参数）则是一种“全局”跳转：</p>

<pre><code>class BookPage &lt; WebApplication
  get('/') do
    # redirect to /users/xxxuser_tidxxx/settings
    redirect Route.to(UserPage, current_user.tid, 'settings')
    # redirect to /p/title-tid
    redirect Route.to(post.url)
  end
end
</code></pre>

<h4 id="slimhelper">SlimHelper</h4>

<p>一个Controller类（如<code>Admin::Analytics::PageViewPage</code>）的template模板文件保存于<code>Route.default_path(Admin::Analytics::PageViewPage)</code>（上面的例子为admin/analytics/page-view）。</p>

<p>注意，因为Controller类可能被mount到<code>default_path</code>之外的URL，所以保存模板文件的位置，与URL的结构并不一致。具体的，<code>Route[Admin::Analytics::PageViewPage]</code>会返回类实际mount的URL地址，而<code>Route.default_path(Admin::Analytics::PageViewPage)</code>的返回值则是模板文件的存储地址。</p>

<p><code>rsp :模板名</code>会将上述模板文件目录下的<code>模板名.slim</code>文件用于render。注意模板名必须以<code>symbol</code>格式指定（注意现在的rsp函数只有一个hash参数）。</p>

<p><code>SlimHelper</code>会尝试从<code>path_info</code>算出默认模板，如果是静态不含<code>:param</code>的路径，则可以直接调用<code>rsp</code>函数，不指定模板文件ID：</p>

<pre><code>class UserPage
  get('/message') # 模板为：app/views/users/message.slim
  get('/settings/nickname')
    # 模板为：app/views/users/settings/nickname.slim
  get(/) { rsp } # app/views/users/index.slim，'/'会自动map到:index
end
</code></pre>

<p>与<code>rsp</code>相对应，<code>rsp!</code>render后直接halt当前进程（即以前的<code>hsp</code>）。</p>

<p>新的<code>SlimHelper</code>不再有<code>common_rsp</code>，应直接<code>@对象变量</code>传递信息。依然有<code>partial :form</code>（使用<code>_form.slim</code>文件作为template），但是不再有<code>partial_block</code>函数（后者应该使用<code>HtmlPresenter</code>机制）。</p>

<p><code>partial</code>功能应该用于template内部，比如：<code>partial :form</code>会调用同一文件夹下的<code>_form.slim</code>。</p>

<h3 id="i18n">模板I18n</h3>

<p>有两种方式在slim模块中实现i18n，两种可以并用。第一种方式是，针对不同locale分别做一个模板，比如<code>index.en.yml</code>和<code>index.ja.yaml</code>。模板的locale必须包含在<code>supported_locales</code>中，默认是<code>en, ja, zh</code>（统一使用缩略写法，不再用’zh-CN’的方式了）。然后render时，指定：</p>

<pre><code>rsp :index, locales: [:en, :ja]
</code></pre>

<p>注意这里的<code>locales</code>表示的是“所有我提供了模板的locales”。这个例子里没有<code>zh</code>模板存在，对指定locale为<code>zh</code>的用户，SlimHelper会使用默认的模板（:en）render。因此，<code>:en</code>模板是必须存在的（这一点未来可能有所改善）。</p>

<p>另一种方法是使用同一个模板，但是用<code>tt(:some_key)</code>将<code>:some_key</code>翻译为不同语言。<code>tt</code>由<code>I18nHelper</code>提供，会自动的按照当前页面寻找正确的scope。比如，<code>app/views/some/template.slim</code>文件里的<code>:some_key</code>，应该在<code>i18n/views/some/en.yml</code>（或<code>ja.yml</code>, <code>zh.yml</code>）里定义为<code>some.template.some_key</code>。</p>

<p>在slim文件内增加新的key到<code>tt</code>之后（注意必须用<code>:xxx</code>，也就是symbol形式），然后执行<code>rake i18n:uv</code>，后者会自动在yaml文件里添加新的key，并通过google translate预设一个翻译。以后则可以通过</p>

<pre><code>$ rake i18n:iye
</code></pre>

<p>启动翻译服务，通过浏览器人力对照翻译。</p>

<h3 id="section-2">面包屑</h3>

<p>因为<code>Route</code>加载时可以指定任意的mount point，比如<code>User::RootPage =&gt; '/'</code>，系统无法从任意位置完全自动的生成面包屑（包括所有上级目录的连接和i18n的页面title）。但是主要遵循几个简单原则，则手动生成面包屑也非常轻松。</p>

<p>首先，所有直接链接到目录的页面，均应命名为<code>index</code>。比如<code>/user/</code>对应<code>user/index</code>。它的i18n标题的翻译键则应该为：<code>user.index.title</code>。</p>

<p>比如<code>User::AccountPage</code>里的<code>get '/message_center'</code>，如果加载在了默认路径（<code>user/accounts/message_center</code>），则它的面包屑的各段的翻译key应该为<code>[:user.index.title, :user.accounts.index.title, :user.accounts.message_center.title]</code>。</p>

<p>理论上只要上述<code>index</code>页面对应的slim模板存在，则<code>rake i18n:uv</code>也应该生成了这些key，在render面包屑时可以使用。注意：千万不要用<code>/title/some.slim</code>或是<code>/some/title.slim</code>命名模板文件。（TODO：未测试）</p>

<h3 id="formtable-helper">Form和Table Helper</h3>

<p>Form Helper延续原版。与flashes helper一样，<code>lib/helpers</code>下面的helper不应该有特定app相关的内容，比如html里的class或者id。这些特定内容需要写在<code>app/helpers</code>下另建的helper文件里（可以重载<code>lib/helpers</code>下的方法，具体参照active record的method chain的介绍）。</p>

<p>TODO: TableHelper暂未实现。需要时可以启动开发。</p>

<h3 id="assetsjscsslogo">Assets（js/css/logo等静态图片）管理</h3>

<p>参照<code>doc/assets_management.html</code></p>

<h3 id="logging-system">Logging System</h3>

<h4 id="labacktracecleaner">LaBacktraceCleaner</h4>

<p>基于ActiveSupport的BacktraceCleaner，去除trace中的不必要信息。</p>

<h4 id="labufferedlogger">LaBufferedLogger</h4>

<p>BufferedLogger是为便于在<code>rack.logger</code>中使用而设计的。</p>

<p><strong>注意</strong> 一定在sinatra的configuration里<code>set :logging, nil</code>。</p>

<p>一个BufferedLogger对象初始化后，会缓存所有信息至内部一个hash的数组，直到到达阈值（默认100）时才会flush!到输出（console，文件或数据库）。</p>

<p>LaBufferedLogger实现标准RubyLogger所支持的所有severity，包括<code>:unknown</code>，支持直接接收Exception对象作为message：</p>

<pre><code>logger.warn 'some detailed message'
logger.error RuntimeError.new('error message')
</code></pre>

<p>另外支持<code>event(type, message, opts)</code>用于接收任何类型的event，以及<code>access</code>记录包含request信息的access log。<code>type</code>可为合法的class名或任意字符串。</p>

<p><code>LaBufferedLogger</code>将上述log信息保存在<code>msgs</code>数组，并在调用flush!时默认输出到控制台，并在调用flush!时其它类可以扩展并重载<code>flash!</code>方法，以输出到文件或保存log信息到数据库。</p>

<h2 id="restful-api">Restful API</h2>

<p>使用<code>json_response</code>将controller的输出（hash，或抛出的一场）转为json。</p>

<p><code>rake rspec:api</code>测试所有<code>spec/pages/api/*</code>下的全部测试，<code>rake doc:api</code>基于这些测试的结果，以及<code>mds/*.api.md</code>生成API文档。</p>

  </div>




</body>
</html>
