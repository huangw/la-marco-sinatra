<!DOCTYPE HTML>
<html>
<head>
  <meta charset='utf-8'>
  <title>Preview</title>
  <!--this style include the test_md/css screen.css(first) and base.css -->
  <style type="text/css">
    pre code{display:block;background:#fff;color:#4d4d4c;font-family:Menlo, Monaco, Consolas, monospace;font-size:12px;line-height:1.5;border:1px solid #ccc;padding:10px}html,body,div,span,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,code,del,dfn,em,img,q,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;font-weight:inherit;font-style:inherit;font-size:100%;font-family:inherit;vertical-align:baseline}table{border-collapse:separate;border-spacing:0}caption,th,td{text-align:left;font-weight:normal}table,td,th{vertical-align:middle}blockquote:before,blockquote:after,q:before,q:after{content:""}blockquote,q{quotes:"" ""}a img{border:none}body{margin:10px}html{height:100%}body{padding:0;margin:0;font:14px/22px "adelle", Georgia, sans-serif;font-size-adjust:none;font-style:normal;font-variant:normal;font-weight:normal;background:#f4f6ec}a{color:#369}#markdown-toc{float:left;width:230px;margin-right:30px;margin-top:40px}#markdown-toc a{display:block;font-weight:bold;text-decoration:none}#markdown-toc #sections{list-style-type:none;border-bottom:3px solid rgba(0,0,0,0.1);padding-bottom:10px;margin-bottom:10px}#markdown-toc #sections>li>a{padding:5px 0;color:#444;font-size:16px}#markdown-toc #sections ul{margin-bottom:15px}#markdown-toc #sections ul li{list-style-type:none}#markdown-toc #sections ul li a{padding:1px 15px;font-size:13px;font-weight:normal}#markdown-toc .extra{padding:5px 0;min-height:1.4em}#markdown-toc .extra a{color:#555;font-size:14px}#markdown-toc #travis img{margin-top:10px;display:block}#markdown-toc>*:last-child{margin-bottom:20px}#content{padding:30px 30px 20px 30px;min-height:100px;width:600px;background:#fff;float:left;border:1px solid rgba(0,0,0,0.2);-webkit-border-radius:3px 3px 0 0;-moz-border-radius:3px 3px 0 0;border-radius:3px 3px 0 0;margin-top:15px}#content #loader{color:#888;width:300px;height:24px;line-height:24px;position:absolute;top:30px;left:30px;background:url("data:image/gif;base64,R0lGODlhGAAYAPYAAP///5mZmfn5+dvb27i4uKmpqaCgoNra2v39/c/Pz6CgoJmZmfT09K+vr66urvb29qWlpaSkpPPz8/v7+87Ozvj4+NXV1dTU1Li4uKysrJubm52dnaqqqu7u7uPj46Ojo8LCwvb29ra2tqenp7q6utzc3JycnNfX1/Ly8uzs7J6ensbGxs3NzeDg4MvLy9LS0r+/v/r6+qysrOrq6t7e3tnZ2cTExLS0tLOzs6ioqLGxsefn57W1tcvLy7y8vMHBwd7e3qKiovHx8cfHx+Hh4QAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH+GkNyZWF0ZWQgd2l0aCBhamF4bG9hZC5pbmZvACH5BAAFAAAAIf8LTkVUU0NBUEUyLjADAQAAACwAAAAAGAAYAAAHmoAAgoOEhYaHgxUWBA4aCxwkJwKIhBMJBguZmpkqLBOUDw2bo5kKEogMEKSkLYgIoqubK5QJsZsNCIgCCraZBiiUA72ZJZQABMMgxgAFvRyfxpixGx3LANKxHtbNth8hy8i9IssHwwsXxgLYsSYpxrXDz5QIDubKlAwR5q2UErC2poxNoLBukwoX0IxVuIAhQ6YRBC5MskaxUCAAIfkEAAUAAQAsAAAAABgAGAAAB6GAAIKDhIWGh4MVFgQOGhsOGAcxiIQTCQYLmZqZGwkIlA8Nm6OaMgyHDBCkqwsjEoUIoqykNxWFCbOkNoYCCrmaJjWHA7+ZHzOIBMUND5QFvzATlACYsy/TgtWsIpPTz7kyr5TKv8eUB8ULGzSIAtq/CYi46Qswn7AO9As4toUMEfRcHZIgC9wpRBMovNvU6d60ChcwZFigwYGIAwKwaUQUCAAh+QQABQACACwAAAAAGAAYAAAHooAAgoOEhYaHgxUWBA4aCzkkJwKIhBMJBguZmpkqLAiUDw2bo5oyEocMEKSrCxCnhAiirKs3hQmzsy+DAgq4pBogKIMDvpvAwoQExQvHhwW+zYiYrNGU06wNHpSCz746O5TKyzwzhwfLmgQphQLX6D4dhLfomgmwDvQLOoYMEegRyApJkIWLQ0BDEyi426Six4RtgipcwJAhUwQCFypA3IgoEAAh+QQABQADACwAAAAAGAAYAAAHrYAAgoOEhYaHgxUWBA4aCxwkJzGIhBMJBguZmpkGLAiUDw2bo5oZEocMEKSrCxCnhAiirKsZn4MJs7MJgwIKuawqFYIDv7MnggTFozlDLZMABcpBPjUMhpisJiIJKZQA2KwfP0DPh9HFGjwJQobJypoQK0S2B++kF4IC4PbBt/aaPWA5+CdjQiEGEd5FQHFIgqxcHF4dmkBh3yYVLmx5q3ABQ4ZMBUhYEOCtpLdAACH5BAAFAAQALAAAAAAYABgAAAeegACCg4SFhoeDFRYEDhoaDgQWFYiEEwkGC5mamQYJE5QPDZujmg0PhwwQpKsLEAyFCKKsqw0IhAmzswmDAgq5rAoCggO/sxaCBMWsBIIFyqsRgpjPoybS1KMqzdibBcjcmswAB+CZxwAC09gGwoK43LuDCA7YDp+EDBHPEa+GErK5GkigNIGCulEGKNyjBKDCBQwZMmXAcGESw4uUAgEAIfkEAAUABQAsAAAAABgAGAAAB62AAIKDhIWGh4MVFgQOGgscJCcxiIQTCQYLmZqZBiwIlA8Nm6OaGRKHDBCkqwsQp4QIoqyrGZ+DCbOzCYMCCrmsKhWCA7+zJ4IExaM5Qy2TAAXKQT41DIaYrCYiCSmUANisHz9Az4fRxRo8CUKGycqaECtEtgfvpBeCAuD2wbf2mj1gOfgnY0IhBhHeRUBxSIKsXBxeHZpAYd8mFS5seatwAUOGTAVIWBDgraS3QAAh+QQABQAGACwAAAAAGAAYAAAHooAAgoOEhYaHgxUWBA4aCzkkJwKIhBMJBguZmpkqLAiUDw2bo5oyEocMEKSrCxCnhAiirKs3hQmzsy+DAgq4pBogKIMDvpvAwoQExQvHhwW+zYiYrNGU06wNHpSCz746O5TKyzwzhwfLmgQphQLX6D4dhLfomgmwDvQLOoYMEegRyApJkIWLQ0BDEyi426Six4RtgipcwJAhUwQCFypA3IgoEAAh+QQABQAHACwAAAAAGAAYAAAHoYAAgoOEhYaHgxUWBA4aGw4YBzGIhBMJBguZmpkbCQiUDw2bo5oyDIcMEKSrCyMShQiirKQ3FYUJs6Q2hgIKuZomNYcDv5kfM4gExQ0PlAW/MBOUAJizL9OC1awik9PPuTKvlMq/x5QHxQsbNIgC2r8JiLjpCzCfsA70Czi2hQwR9FwdkiAL3ClEEyi829Tp3rQKFzBkWKDBgYgDArBpRBQIADsAAAAAAAAAAAA=") no-repeat center left;padding-left:32px;font-size:18px}#content>p{zoom:1}#content>p:before,#content>p:after{content:"";display:table}#content>p:after{clear:both}#content p{padding:0 0 0.8125em 0;color:#444}#content p img{float:left;margin:0.5em 0.8125em 0.8125em 0;padding:0}#content img{max-width:100%}#content h1,#content h2,#content h3,#content h4,#content h5,#content h6{font-weight:bold;line-height:1.2em}#content h1{font-size:2.125em;margin-bottom:0.4em}#content h2{font-size:1.7em;margin:0.855em 0 0.4em;color:#cc333f}#content h3{font-size:1.3em;margin:0.956em 0 0.4em}#content h4{font-size:1.1em;margin:1.161em 0 0.4em}#content h5,#content h6{font-size:1em;font-weight:bold;margin:1.238em 0 0.4em}#content>h1,#content>h2{margin-top:0}#content ul{list-style-position:outside}#content li ul,#content li ol{margin:0 1.625em}#content ul,#content ol{margin:0 0 1.625em 1.25em}#content dl{margin:0 0 1.625em 0}#content dl dt{font-weight:bold}#content dl dd{margin-left:1.625em}#content a{text-decoration:none}#content a:hover{text-decoration:underline}#content table{margin-bottom:1.625em;border-collapse:collapse}#content th{font-weight:bold}#content tr,#content th,#content td{margin:0;padding:0 1.625em 0 1em;height:26px}#content tfoot{font-style:italic}#content caption{text-align:center;font-family:Georgia, serif}#content abbr,#content acronym{border-bottom:1px dotted #000}#content address{margin-top:1.625em;font-style:italic}#content del{color:#000}#content blockquote{padding:1em 1em 1.625em 1em;font-family:georgia, serif;font-style:italic}#content blockquote:before{content:"\201C";font-size:3em;margin-left:-0.625em;font-family:georgia, serif;color:#aaa;line-height:0}#content blockquote>p{padding:0;margin:0}#content strong{font-weight:bold}#content em,#content dfn{font-style:italic}#content dfn{font-weight:bold}#content pre,#content code{margin:0 0 1.625em;white-space:pre}#content pre,#content code,#content tt{font-size:1em;font-family:Consolas, "Andale Mono WT", "Andale Mono", "Lucida Console", "Lucida Sans Typewriter", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono", "Nimbus Mono L", Monaco, "Courier New", Courier, monospace;line-height:1.5}#content code{background:#f7f8f1;padding:1px 2px;border:1px solid #ccc}#content pre code{padding:10px 12px;word-wrap:normal;overflow-y:auto}#content tt{display:block;margin:1.625em 0}#content hr{margin-bottom:1.625em}#content table{font-family:"Helvetica Neue", Helvetica, Arial, sans-serif;width:100%}#content th,#content td{padding:5px 10px;border:1px solid #ccc}#content th{background:#eee;padding:7px 10px}#content td{font-size:0.9em;border-color:#ddd}#content tbody tr:nth-child(2n){background:#f5f5f5}@media only screen and (max-width: 480px){#container{width:100%}#markdown-toc{width:100%;margin-top:10px;float:none}#markdown-toc #sections,#markdown-toc #header,#markdown-toc .extra{padding-left:30px;padding-right:30px}#content{-webkit-border-radius:0;-moz-border-radius:0;border-radius:0;border-width:1px;float:none;margin:0;width:100%;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}}@media only screen and (min-device-pixel-ratio: 1.5), only screen and (min-resolution: 1.5dppx){#github-ribbon img{width:100px}}*{margin:0;padding:0}body{margin-left:40px}#markdown-toc{float:right !important;position:fixed;left:745px;height:90%;overflow:auto}#content{float:left !important;filter:progid:DXImageTransform.Microsoft.Shadow(color=#909090,direction=120,strength=4);-moz-box-shadow:2px 2px 10px #909090;-webkit-box-shadow:2px 2px 10px #909090;box-shadow:2px 2px 10px #909090}#markdown-toc{width:auto;max-width:300px !important;top:40px}#markdown-toc>li>ul>li>a{color:#cc333f;margin-top:10px}#markdown-toc>li>ul>li>ul>li>a,h3{color:#009999}#markdown-toc>li>ul>li>ul>li>ul>li>a,h4{color:#669999}#markdown-toc>li>a{margin-bottom:20px;padding-bottom:20px;border-bottom:3px solid rgba(0,0,0,0.1);font-size:20px;color:#000000}#content code{border-radius:3px}#content>h1{font-size:2.0em}.title{font-size: 2.4em;color: #ff5456 !important}#markdown-toc>li{margin-bottom: 30px}#markdown-toc>li>a{padding-bottom:10px;}#markdown-toc>li>a{font-size: 18px;}#markdown-toc{white-space: nowrap}h1,h2,h3,h4,h5,h6{margin-bottom:1em !important;}#markdown-toc>li>ul>li>ul>li>ul>li>ul>li>a,h5{color:#7bb8b8 !important}#markdown-toc>li>ul>li>ul>li>ul>li>a,h4{color:#6c9e00 !important}#markdown-toc>li>ul>li>ul>li>a, h3{color:#3C6E6E  !important}#markdown-toc>li>ul>li>a, h2{color:#4E6EA0 !important}#markdown-toc>li>a, h1{color:#134da5 !important}body{background:#ffffff}.code pre{border:1px solid rgb(204, 204, 204);overflow:auto;border-radius:3px}.code pre{background: none repeat scroll 0% 0% rgb(247, 248, 241)}#content sup{background: #c8deff}#content sup a{color: #273650}#content .footnotes{background: rgba(0,0,0,0.1);padding: 10px 0 0px 10px;border-radius: 5px}.reversefootnote{color: #000000;}
  </style>
  
</head>

<body>
  <div id="content">
    
<ul id="markdown-toc">
  <li><a href="#assets" id="markdown-toc-assets">Assets文件管理</a>    <ul>
      <li><a href="#section" id="markdown-toc-section">概要</a></li>
      <li><a href="#section-1" id="markdown-toc-section-1">使用流程</a>        <ul>
          <li><a href="#section-2" id="markdown-toc-section-2">图片管理</a></li>
          <li><a href="#git" id="markdown-toc-git">第三方Git库的下载管理</a></li>
          <li><a href="#cssjs" id="markdown-toc-cssjs">CSS和JS文件管理</a>            <ul>
              <li><a href="#section-3" id="markdown-toc-section-3">虚拟文件和最小化</a></li>
              <li><a href="#url" id="markdown-toc-url">URL地址和文件获取</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#section-4" id="markdown-toc-section-4">技术实现</a>        <ul>
          <li><a href="#assetsettings" id="markdown-toc-assetsettings">AssetSettings</a></li>
          <li><a href="#assets-helper" id="markdown-toc-assets-helper">Assets Helper</a></li>
          <li><a href="#assets-controller" id="markdown-toc-assets-controller">Assets Controller</a></li>
          <li><a href="#assets-mapper" id="markdown-toc-assets-mapper">Assets Mapper</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h1 id="assets">Assets文件管理</h1>

<h2 id="section">概要</h2>

<ul>
  <li>管理（包括编译和最小化）<code>js/css</code>文件，同时管理logo，icon等静态图片</li>
  <li>支持从git或http下载第三方<code>js/css</code>文件到本地</li>
  <li>AssetsHelper统一提供<code>js_tag</code>, <code>css_tag</code>和<code>img_tag</code>，根据三种不同的环境提供不同的文件地址：
    <ol>
      <li><code>:production</code>：等同于<code>RACK_ENV</code>的生产环境，能够使用单独Asset服务器
（<code>img.vikkr.com, assets.vikkr.com</code>等）</li>
      <li><code>:local_assets</code>：<code>RACK_ENV</code>还是<code>production</code>，但是使用本地图片和本地<code>css/js</code>
的最小化文件。启动服务器时需制定参数<code>RACK_ENV=production LOCAL_ASSETS = true</code>。</li>
      <li><code>:development</code>，等同所有非production环境，使用本地未最小化的css/js文件。</li>
    </ol>
  </li>
  <li>css/js可以使用第三方CDN提供的地址，但在上述2.和3.的情况下，会使用下载备份到本地的文件，
因此即使没有网络也可以完成本地测试。</li>
  <li>通过ruby DSL写assets的设置（默认在<code>app/assets/mappings.rb</code>），可以支持更灵活的语法
 （取代以前的<code>definition.yml</code>，AssetsHelper使用的设置文件依然保存在<code>config/assets.yml</code>）</li>
  <li>暂时不负责编译<code>coffee/sass</code>文件。应通过<code>sass -w</code>或其它命令行工具另行编译成<code>js/css</code>文件，
并在<code>mappings.rb</code>里加载编译后的<code>js/css</code>文件地址</li>
</ul>

<h2 id="section-1">使用流程</h2>

<h3 id="section-2">图片管理</h3>

<ul>
  <li>
    <p>静态图片默认存放在<code>app/assets/img</code>下（可通过设置变量<code>img_dir</code>修改，但是不建议修改）：</p>

    <p>img_dir ‘other/directory/for/img’ # default is app/assets/img</p>
  </li>
  <li>
    <p>文件可以保存于根目录，如<code>app/assets/img/logo.jpg</code>，也可建任意多层子目录如
<code>app/assets/img/icon/group.jpg</code>。</p>
  </li>
</ul>

<p>为符合URL规范，注意不要用<code>_</code>命名文件或文件夹（可用<code>-</code>）。</p>

<ul>
  <li>
    <p>指定服务器在不同的环境下如何从图片ID生成图片URL（最后的<code>/</code>可选）：</p>

    <p>img_url_prefix production: ‘http://img.vikkr.com’,
                 local: ‘/img’</p>
  </li>
</ul>

<p>对于任意图片，如<code>image_filename = icon/group/friends.png</code>，调用<code>img_tag</code>的方法为：</p>

<pre><code>= img_tag('icon/group/friends.png')
</code></pre>

<p><code>:production</code>环境下使用<code>img_url_prefix.remote</code>，而。
<code>:local_assets</code>和<code>:development</code>使用<code>img_url_prefix.local</code>。</p>

<ul>
  <li>
    <p><code>AssetsHelper.img_tag(image_filename)</code>中图片URL为：
<code>&lt;当前环境的img_url_prefix&gt;/&lt;image_filename&gt;</code>。
如<code>http://img.vikkr.com/icon/group/friends.png</code>（生产环境），
<code>/img/icon/group/friends.png</code>（其它环境）。</p>
  </li>
  <li>
    <p><code>ImageController</code>则会在<code>app/assets/img/icon/group/friends.png</code>
中寻找图片文件并<code>sendfile</code>给用户。</p>
  </li>
  <li>
    <p>执行<code>rake assets:map</code>，<code>rake assets:update</code>或者
<code>rake assets:compile</code>会更新<code>config/assets.yml</code>，服务器（WebApplication）
通过读取此文件获得 <code>AssetsSettings::EnvironmentSettings</code>的
singleton instance，并在非production环境时，mount
<code>AssetsMapper::ImageController</code>到<code>/img</code>（即<code>img_url_prefix.local</code>的设置位置）。</p>
  </li>
</ul>

<p>AssetHelper并不管理具体文件的尺寸，因此需要时应手动指定尺寸：</p>

<pre><code>= img_tag('icon/group/friends.png', width: 230)
</code></pre>

<p>非生产环境下可以通过<code>localhost:8080/img/index</code>列出所有现有静态图片的id和尺寸。</p>

<h3 id="git">第三方Git库的下载管理</h3>

<pre><code>pull :repoid, git: 'http://some.url.com/git/repository.git'
pull :jquery2, github: 'jquery/jquery' # github可直接指定repository名称
pull :la-marco, 7lime: 'vikkr/la-marco' # gitlab.7lime.com的库也可缩写
</code></pre>

<p>会将<code>https://github.com/jquery/jquery</code>下载到<code>~/.assets_cache/jquery2</code>
（或任意指定的<code>pull_dir</code>）。</p>

<p>注意用symbol指定下载文件夹名称（否则会被当做实际目录名而非<code>~/.aasets_cache</code>下的目录名）。</p>

<p>以后就可通过vendor命令，从vendor库里拷贝文件了：</p>

<pre><code>produce('some.js') { vendor 'lib/some/file/vieee.jp', from: :jquery2 }
</code></pre>

<p>这个文件默认会被拷贝到<code>app/assets/vendor/jquery2/vieee.jp</code>
(<code>vendor_dir</code> + repository名 + 文件basename)。</p>

<h3 id="cssjs">CSS和JS文件管理</h3>

<h4 id="section-3">虚拟文件和最小化</h4>

<p>CSS和JS管理的核心是虚拟文件（对应一个<code>AssetMapper::TargetFile</code>），如<code>application.js</code>,
<code>editor.css</code>，每一个虚拟文件都是有一个或多个文件（<code>AssetMapper::SourceFile</code>）组成的。
在<code>mappings.rb</code>文件里，通过<code>produce</code>命令设置：</p>

<pre><code>produce 'application.js' do
  cloud '//code.jquery.com/jquery-2.1.3.min.js'
    # 文件会被拷贝到`app/assets/cloud/code.jquery.com/jquery-2.1.3.min.js`

  vendor 'lib/min/sometool.min.js', from: :bootstrap
    # `~/.assets_cache/bootstrap`需已经存在
    # 文件默认会被拷贝到`app/assets/vendor/bootstrap/sometool.min.js`

  file 'js/article-editor.js' # 使用 `app/assets/js/article-editor.js`
                              # `app/assets`可通过`assets_dir`命令修改，
                              # 所有文件地址均相对于此地址指定
  file 'js/subdir/myown.js' # 使用`app/assets/js/subdir/myown.js`，
end

produce 'editor.css', minimize_to: 'public/assets/css' do
  ...
end
</code></pre>

<p><strong>vendor</strong> 是copy过来用、并会被压缩到我们自己的最小化<code>js/css</code>中的文件
（比如application.versionid.js）。而 <strong>cloud</strong> 在生产环境中则是直接远程调用的，
但是也会下载一个本地备份用于<code>:development</code>和<code>:local_assets</code>时的测试。</p>

<p><strong>file</strong> 则是普通的我们自己开发的<code>js/css</code>文件。它们可能从<code>coffee/sass/less</code>等编译而来，
这里应该指定生成的<code>js/css</code>文件。</p>

<p><code>rake assets:compile</code>会针对每一个produce对象在<code>app/assets/min/</code>
（此为<code>min_dir</code>变量默认所指定的目录）下生成最小化的js和css版本，并有含短缩时间戳的版本号
（如<code>application.dfwee.js</code>，<code>dfwee</code>即为版本号，每秒钟对应一个，可从中复原时间戳）。</p>

<p>也可另行定义min文件的存储地址：</p>

<pre><code>produce 'editor.css', minimize_to: 'public/assets/css' do
  ...
end
</code></pre>

<p><code>cloud</code>指定的文件不会被压缩。</p>

<p>注意<code>cloud</code>和<code>vendor/file</code>混在时，无论其指定顺序如何，<code>cloud</code>文件永远会在缩小版文件前被调用。</p>

<p><code>vendor/file</code>文件则会按照定义的顺序调用或压缩在一起。</p>

<h4 id="url">URL地址和文件获取</h4>

<p>与图片一样，生产环境下压缩后的js/css文件应该保存于<code>//assets.vikkr.com</code>之类的子域名
（可能在OSS上）。需要指定为：</p>

<pre><code>assets_url_prefix production: 'http://assets.vikkr.com'
                  local: '/assets'
</code></pre>

<p>原理与<code>image_url_prefix</code>一样。</p>

<p>对任一个produce的filename（如<code>js_tag('application.js')</code>），<code>js_tag</code>和<code>css_tag</code>
会按设置顺序输出一个或多个<code>&lt;link&gt;/&lt;script&gt;</code>。</p>

<ul>
  <li><code>:production</code>环境下，cloud文件单独采用指定的地址，其他本地文件最小化为带版本号的一个文件，
以<code>&lt;assets_url_prefix.production&gt;/application.xdewrwer.js</code>形式提供。</li>
  <li><code>:local_assets</code>环境下，cloud文件为本地备份文件地址，其他本地文件最小化为带版本号的一个文件，
以<code>&lt;assets_url_prefix.local&gt;/application.xdewrwer.js</code>形式提供。</li>
  <li><code>:development</code>环境下，单独返回使用每一个组成文件，均为本地文件的URL地址</li>
</ul>

<h2 id="section-4">技术实现</h2>

<h3 id="assetsettings">AssetSettings</h3>

<p><code>lib/asset_settings.rb</code>文件负责解析并更新<code>config/assets.yml</code>文件。</p>

<p>后者将<code>:production/:development/:local_assets</code>三个文件分别保存，<code>WebController</code>等
controller在runtime根据当前环境获取其中一个（singleton对象）。</p>

<p><code>assets.yml</code>里定义一个root地址（相当于<code>APP_ROOT</code>），对于图片只保存<code>img_dir</code>
（相对于<code>APP_ROOT</code>）和<code>img_url_prefix</code>。对于css/js文件，则保存<code>files</code>Hash，
为<code>虚拟文件 =&gt; 原始文件数组</code>的列表。
原始文件数组的元素均为经过了<code>aasets_url_prefix</code>转换后的URL地址
（注意：本地地址均是相对于<code>root</code>的）。</p>

<p>【SOURCE】<a href="./spec/lib/asset_settings.html"><code>lib/asset_settings.rb</code></a> 
【SOURCE】<a href="./spec/lib/asset_settings/environment_settings.html"><code>lib/asset_settings/environment_settings.rb</code></a></p>

<h3 id="assets-helper">Assets Helper</h3>

<p>提供<code>img_tag</code>, <code>css_tag</code>和<code>js_tag</code>，根据<code>config/assets.yml</code>（<code>AssetsSettings</code>）的设置，
在不同的环境（<code>:production/:local_assets/:development</code>）输出不同的资源列表。</p>

<p>【SOURCE】<a href="./spec/lib/helpers/assets_helper.html"><code>lib/helpers/assets_helper.rb</code></a></p>

<h3 id="assets-controller">Assets Controller</h3>

<p>因为资产文件不再放置于<code>public</code>文件夹下，需要根据需要（一般由WebApplication）
在Route里加载<code>ImageControler</code>和<code>AssetController</code>以提供这些文件（具体的mount地址也从
<code>AssetsConfig</code>获取）。</p>

<p>【SOURCE】<a href="./spec/lib/controllers/assets_controller.html"><code>lib/controllers/assets_controller.rb</code></a> 
【SOURCE】<a href="./spec/lib/controllers/image_controller.html"><code>lib/controllers/image_controller.rb</code></a></p>

<h3 id="assets-mapper">Assets Mapper</h3>

<p>此类仅在开发环境下通过<code>rake assets:*</code>使用。负责解析<code>app/assets/mappings.rb</code>，
根据需要下载、复制、编译或最小化压缩文件，更新YAML设置文件。</p>

<p>【SOURCE】<a href="./spec/lib/devtools/asset_mapper.html"><code>lib/devtools/asset_mapper.rb</code></a></p>

  </div>




</body>
</html>
