<!DOCTYPE HTML>
<html>
<head>
  <meta charset='utf-8'>
  <title>Preview</title>
  <!--this style include the test_md/css screen.css(first) and base.css -->
  <style type="text/css">
    pre code{display:block;background:#fff;color:#4d4d4c;font-family:Menlo, Monaco, Consolas, monospace;font-size:12px;line-height:1.5;border:1px solid #ccc;padding:10px}html,body,div,span,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,code,del,dfn,em,img,q,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;font-weight:inherit;font-style:inherit;font-size:100%;font-family:inherit;vertical-align:baseline}table{border-collapse:separate;border-spacing:0}caption,th,td{text-align:left;font-weight:normal}table,td,th{vertical-align:middle}blockquote:before,blockquote:after,q:before,q:after{content:""}blockquote,q{quotes:"" ""}a img{border:none}body{margin:10px}html{height:100%}body{padding:0;margin:0;font:14px/22px "adelle", Georgia, sans-serif;font-size-adjust:none;font-style:normal;font-variant:normal;font-weight:normal;background:#f4f6ec}a{color:#369}#markdown-toc{float:left;width:230px;margin-right:30px;margin-top:40px}#markdown-toc a{display:block;font-weight:bold;text-decoration:none}#markdown-toc #sections{list-style-type:none;border-bottom:3px solid rgba(0,0,0,0.1);padding-bottom:10px;margin-bottom:10px}#markdown-toc #sections>li>a{padding:5px 0;color:#444;font-size:16px}#markdown-toc #sections ul{margin-bottom:15px}#markdown-toc #sections ul li{list-style-type:none}#markdown-toc #sections ul li a{padding:1px 15px;font-size:13px;font-weight:normal}#markdown-toc .extra{padding:5px 0;min-height:1.4em}#markdown-toc .extra a{color:#555;font-size:14px}#markdown-toc #travis img{margin-top:10px;display:block}#markdown-toc>*:last-child{margin-bottom:20px}#content{padding:30px 30px 20px 30px;min-height:100px;width:600px;background:#fff;float:left;border:1px solid rgba(0,0,0,0.2);-webkit-border-radius:3px 3px 0 0;-moz-border-radius:3px 3px 0 0;border-radius:3px 3px 0 0;margin-top:15px}#content #loader{color:#888;width:300px;height:24px;line-height:24px;position:absolute;top:30px;left:30px;background:url("data:image/gif;base64,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") no-repeat center left;padding-left:32px;font-size:18px}#content>p{zoom:1}#content>p:before,#content>p:after{content:"";display:table}#content>p:after{clear:both}#content p{padding:0 0 0.8125em 0;color:#444}#content p img{float:left;margin:0.5em 0.8125em 0.8125em 0;padding:0}#content img{max-width:100%}#content h1,#content h2,#content h3,#content h4,#content h5,#content h6{font-weight:bold;line-height:1.2em}#content h1{font-size:2.125em;margin-bottom:0.4em}#content h2{font-size:1.7em;margin:0.855em 0 0.4em;color:#cc333f}#content h3{font-size:1.3em;margin:0.956em 0 0.4em}#content h4{font-size:1.1em;margin:1.161em 0 0.4em}#content h5,#content h6{font-size:1em;font-weight:bold;margin:1.238em 0 0.4em}#content>h1,#content>h2{margin-top:0}#content ul{list-style-position:outside}#content li ul,#content li ol{margin:0 1.625em}#content ul,#content ol{margin:0 0 1.625em 1.25em}#content dl{margin:0 0 1.625em 0}#content dl dt{font-weight:bold}#content dl dd{margin-left:1.625em}#content a{text-decoration:none}#content a:hover{text-decoration:underline}#content table{margin-bottom:1.625em;border-collapse:collapse}#content th{font-weight:bold}#content tr,#content th,#content td{margin:0;padding:0 1.625em 0 1em;height:26px}#content tfoot{font-style:italic}#content caption{text-align:center;font-family:Georgia, serif}#content abbr,#content acronym{border-bottom:1px dotted #000}#content address{margin-top:1.625em;font-style:italic}#content del{color:#000}#content blockquote{padding:1em 1em 1.625em 1em;font-family:georgia, serif;font-style:italic}#content blockquote:before{content:"\201C";font-size:3em;margin-left:-0.625em;font-family:georgia, serif;color:#aaa;line-height:0}#content blockquote>p{padding:0;margin:0}#content strong{font-weight:bold}#content em,#content dfn{font-style:italic}#content dfn{font-weight:bold}#content pre,#content code{margin:0 0 1.625em;white-space:pre}#content pre,#content code,#content tt{font-size:1em;font-family:Consolas, "Andale Mono WT", "Andale Mono", "Lucida Console", "Lucida Sans Typewriter", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono", "Nimbus Mono L", Monaco, "Courier New", Courier, monospace;line-height:1.5}#content code{background:#f7f8f1;padding:1px 2px;border:1px solid #ccc}#content pre code{padding:10px 12px;word-wrap:normal;overflow-y:auto}#content tt{display:block;margin:1.625em 0}#content hr{margin-bottom:1.625em}#content table{font-family:"Helvetica Neue", Helvetica, Arial, sans-serif;width:100%}#content th,#content td{padding:5px 10px;border:1px solid #ccc}#content th{background:#eee;padding:7px 10px}#content td{font-size:0.9em;border-color:#ddd}#content tbody tr:nth-child(2n){background:#f5f5f5}@media only screen and (max-width: 480px){#container{width:100%}#markdown-toc{width:100%;margin-top:10px;float:none}#markdown-toc #sections,#markdown-toc #header,#markdown-toc .extra{padding-left:30px;padding-right:30px}#content{-webkit-border-radius:0;-moz-border-radius:0;border-radius:0;border-width:1px;float:none;margin:0;width:100%;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}}@media only screen and (min-device-pixel-ratio: 1.5), only screen and (min-resolution: 1.5dppx){#github-ribbon img{width:100px}}*{margin:0;padding:0}body{margin-left:40px}#markdown-toc{float:right !important;position:fixed;left:745px;height:90%;overflow:auto}#content{float:left !important;filter:progid:DXImageTransform.Microsoft.Shadow(color=#909090,direction=120,strength=4);-moz-box-shadow:2px 2px 10px #909090;-webkit-box-shadow:2px 2px 10px #909090;box-shadow:2px 2px 10px #909090}#markdown-toc{width:auto;max-width:300px !important;top:40px}#markdown-toc>li>ul>li>a{color:#cc333f;margin-top:10px}#markdown-toc>li>ul>li>ul>li>a,h3{color:#009999}#markdown-toc>li>ul>li>ul>li>ul>li>a,h4{color:#669999}#markdown-toc>li>a{margin-bottom:20px;padding-bottom:20px;border-bottom:3px solid rgba(0,0,0,0.1);font-size:20px;color:#000000}#content code{border-radius:3px}#content>h1{font-size:2.0em}.title{font-size: 2.4em;color: #ff5456 !important}#markdown-toc>li{margin-bottom: 30px}#markdown-toc>li>a{padding-bottom:10px;}#markdown-toc>li>a{font-size: 18px;}#markdown-toc{white-space: nowrap}h1,h2,h3,h4,h5,h6{margin-bottom:1em !important;}#markdown-toc>li>ul>li>ul>li>ul>li>ul>li>a,h5{color:#7bb8b8 !important}#markdown-toc>li>ul>li>ul>li>ul>li>a,h4{color:#6c9e00 !important}#markdown-toc>li>ul>li>ul>li>a, h3{color:#3C6E6E  !important}#markdown-toc>li>ul>li>a, h2{color:#4E6EA0 !important}#markdown-toc>li>a, h1{color:#134da5 !important}body{background:#ffffff}.code pre{border:1px solid rgb(204, 204, 204);overflow:auto;border-radius:3px}.code pre{background: none repeat scroll 0% 0% rgb(247, 248, 241)}#content sup{background: #c8deff}#content sup a{color: #273650}#content .footnotes{background: rgba(0,0,0,0.1);padding: 10px 0 0px 10px;border-radius: 5px}.reversefootnote{color: #000000;}
  </style>
  
</head>

<body>
  <div id="content">
    
<ul id="markdown-toc">
  <li><a href="#routepuma" id="markdown-toc-routepuma">Route机制和Puma进程管理</a>    <ul>
      <li><a href="#route" id="markdown-toc-route">Route管理</a></li>
      <li><a href="#path" id="markdown-toc-path">获取特定path</a></li>
      <li><a href="#controller" id="markdown-toc-controller">启动时加载Controller</a></li>
      <li><a href="#puma" id="markdown-toc-puma">Puma进程管理</a></li>
    </ul>
  </li>
</ul>

<h1 id="routepuma">Route机制和Puma进程管理</h1>

<h2 id="route">Route管理</h2>

<p>Route定义一个全局（通过Route类的一个eigenclass变量）的路由表，记录controller类（<code>UserPage</code>等，遵循rack标准）到URL path（mounting point，如<code>/users</code>）的映射关系。</p>

<p><code>Route.table</code>返回<code>类 =&gt; 路径</code>，<code>Route.all</code>则返回<code>路径 =&gt; 类</code>格式的Hash。</p>

<p>注意1.9之后的Ruby Hash是有序的，all的顺序与table相反。</p>

<p>一般来说，我们通过<code>Route.mount AppClass, '/path'</code>或
<code>Route &lt;&lt; AppClass</code>将controller加载到<code>Route.table</code>，当path没有指定时，Route会自动转换<code>NameSpace::ClassNamePage</code>为<code>name/space/class/names</code>的形式（末尾的<code>Controller/Page/API</code>会被删除，然后复数化）。</p>

<p>Controller类使用默认route路径时，可以在定义时直接加载：</p>

<pre><code>class UserPage &lt; WebApplication
  get('/') { ... }

  Route &lt;&lt; self
end
</code></pre>

<p>默认路径由<code>default_route</code>函数根据类名（<code>UserPage</code>）计算出。</p>

<p>也可同时定义特定path：</p>

<pre><code>class UserPage &lt; WebApplication
  get('/') { ... }

  Route.mount(self, '/user')
end
</code></pre>

<p>或在任意地方、根据特定条件加载：</p>

<pre><code>Route.mount(LogViewApp, '/logs') if RACK_ENV == 'development'
</code></pre>

<p>【SOURCE】<a href="./spec/lib/route.html"><code>lib/route.rb</code></a> (RSpec <a href="./spec/spec/lib/route_spec.html">src</a> <a href="./spec/spec/lib/route_spec_rslt.html">rslt</a>)</p>

<h2 id="path">获取特定path</h2>

<p><code>to</code>（<code>url</code>的同名函数）是sinatra提供的获取同一controller内其它页面URL的方法，比如</p>

<pre><code>class UserPage &lt; WebApplication
  get('/settings') { ... }
  get('/') { rediret to('settings') } # redirect to the url of above

  Route &lt;&lt; self # =&gt; mount to '/users/'
end
</code></pre>

<p><code>Route.to</code>方法（可接受多个参数）则是一种“全局”跳转：</p>

<pre><code>class BookPage &lt; WebApplication
  get('/') do
    # redirect to /users/xxxuser_tidxxx/settings
    redirect Route.to(UserPage, current_user.tid, 'settings')
    # redirect to /p/title-tid
    redirect Route.to(post.url)
  end
end
</code></pre>

<h2 id="controller">启动时加载Controller</h2>

<p>程序启动时<code>config/boot.rb</code>会在<code>config/routes.rb</code>文件存在时调用它，后者会顺序加载所有<code>app/helpers</code>和<code>app/pages</code>下面的ruby文件。旧版的<code>app/lib/*</code>文件移动到<code>lib</code>目录下，需要使用时手动加载（一般来说应该已经被base controller加载了）。</p>

<p>最后<code>config/routes.rb</code>会“从浅到深”的加载<code>app/pages</code>下的所有文件。<code>Route.all</code>会以相反的顺序将其map到<code>control.ru</code>。
这样大致可以保证<code>/</code>之类更“一般”的route会出现在寻址表的最后。
<code>config.ru</code>（标准的rack程序入口）里，会顺序调用并map所有的<code>Route.all</code>到一个大的<code>Rack::Builder</code> application。</p>

<p>【SOURCE】<a href="./spec/config/initializers/routes.html"><code>config/initializers/routes.rb</code></a></p>

<p>注意<code>web exceptions</code>设置文件中定义了特定Ruby异常对应的HTTP错误代码，会被<code>routes</code>初始化脚本调用：</p>

<p>【SOURCE】<a href="./spec/config/initializers/web_exceptions.html"><code>config/initializers/web_exceptions.rb</code></a></p>

<h2 id="puma">Puma进程管理</h2>

<p>重新使用<code>foreman</code>，用于开发和测试时启动各种服务器包括<code>puma</code>。启动<code>puma</code>时会调取<code>config/puma.rb</code>文件，监听8080端口并记录<code>pid</code>文件到本地<code>tmp</code>文件夹下，可通过<code>rake s</code>（<code>rake puma</code>的别名）快速重启。</p>

<p>注意<code>puma.rb</code>设置文件屏蔽了<code>access log</code>，必要时可以打开（屏蔽掉<code>quiet</code>一行）。</p>

<p>【SOURCE】<a href="./spec/config/puma.html"><code>config/puma.rb</code></a></p>

<p>注意<code>app/pages/simplest_page</code>定义了一个<code>get</code>的<code>hello world</code>页面，启动puma后可以通过<code>http://localhost:8080/simple</code>确认是否能正常显示。</p>

<p>【SOURCE】<a href="./spec/pages/simplest_page.html"><code>app/pages/simplest_page.rb</code></a></p>

<p>另外，<code>Guardfile</code>通过<code>guard-rake</code>插件动态监听本地文件的修改。建议在两个不同的terminal窗口分别启动<code>forman start</code>和<code>bundle exec guard</code>。则任何时候修改<code>app/pages/...</code>下的文件时<code>guad</code>会自动重启<code>puma</code>，不需要手动执行<code>rake s</code>了。</p>

  </div>




</body>
</html>
